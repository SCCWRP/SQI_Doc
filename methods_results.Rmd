---
title: "The Stream Condition Index: A Multi-Indicator Tool For Enhancing Environmental Management Communication"
output: 
  bookdown::word_document2:
    reference_docx: my_styles.docx
bibliography: refs.bib
author: 'Marcus W. Beck (marcusb@sccwrp.org), Raphael D. Mazor (raphaelm@sccwrp.org), Kenneth C. Schiff (kens@sccwrp.org'
urlcolor: blue
link-citations: true
---

```{r setup, echo = F, warning = F, message = F, results = 'hide'}
# figure path, chunk options
knitr::opts_chunk$set(fig.path = 'figs/', warning = F, message = F, echo = F, cache = T, dev.args = list(family = 'serif'), dpi = 300, warning = F, out.width = '100%', cache.path = 'manu_draft_cache/',
  fig.process = function(x) {
  x2 = sub('-\\d+([.][a-z]+)$', '\\1', x)
  if (file.rename(x, x2)) x2 else x
  })

# libraries
library(Jabbrev)
library(sf)
library(tidyverse)
library(gridExtra)
library(grid)
library(directlabels)
source('R/funcs.R')

# data
data(alldatavg)
data(sheds)
data(wqglm)
data(habglm)

# extract bib entries from online
bib_scrp('methods_results.Rmd', 'refs.bib')

# all colors used for categories
allcol <- getdsccol(palout = T)
```

# Methods

## General Approach

The SQI is a conceptual approach to describing stream health that is based on a stressor-response relationship between biology and in-stream stressors.  Using these relationships, the index provides a categorical description of overall stream health to support high-level management decisions, while also providing descriptions of the biological, chemical, and physical components that establish the foundation of the index to further evaluate which factors are driving stream health.  These tiers of information represent overall stream health, biological health, and stressor condition as single, actionable catogeries.  However, the underlying stressor-response relationships that define the categories are based on empirical models that describe a modelled likelihood of chemical or physical stressors impacting the separate components of biological condition.  Scientists and managers can easily access different components of the SQI depending on the desired level of information within the stressor-response paradigm. 

The stressor-response model used by the SQI uses biological endpoints as indicators of beneficial uses for wadeable streams and water chemistry and physical habitat measurements as stressors that are empirically linked to biological condition.  Biological indices for aquatic macroinvertebrates and algal communities have been developed for California streams and both indices are used as complementary lines of evidence within the SQI.  Multiple taxa groups provide a more balanced indication of biological condition that can confirm overall stream health or provide additional diagnostic information about stressors as different communities may respond to different characteristics of stream habitat.  Water chemistry stressors were those that commonly affect biological condition in perennial streams, such as nutrients and conductivity.  Likewise, physical habitat was described generally as flow, channel, and riparian condition observed at a site.  Although physical habitat can be considered a response metric of stream health depending on the context, physical habitat herein is considered a stressor that can affect biological condition within the stressor-response model. 

## Response components

Two biological indices previously developed for California wadeable streams provide the foundation for evaluating biological integrity within the SQI.  First, the California Stream Condition Index (CSCI, @Mazor16) is a predictive index that compares observed macroinvertebrate taxa and metrics at a site to those expected under least disturbed reference conditions [@Stoddard06]. Expected values at a site are based on models that estimate the likely macroinvertebrate community relative to factors that naturally influence biology [@Moss87;@Cao07]. The CSCI score at a site can vary from 0 to ~ 1.4, with higher values indicating less deviation from reference state. CSCI scores have consistent meaning in different geogrpahic settings because the index was developed to minimize the influence of natural gradients on macroinvertebrate communities. Second, the Algal Stream Condition Index (ASCI, @Therouxip) was similarly developed using diatom and soft-bodied algae as response endpoints at lower trophic levels.  This index follows a multimetric approach where observed metrics were evaluated against statewide references sites that were chosen to characterize least disturbed algal communities.  Unlike the CSCI, the ASCI is not a predictive index because observed metrics had sufficient precision, accuracy, and responsiveness to characterize statewide patterns in algal integrity.  

## Stressor components

Water chemisty and physical habitat measurements were used to describe stressors associated with changes in CSCI and ASCI scores.  The water chemistry data included total nitrogen (mg/L), total phosphorus (mg/L) and specific conductivity ($\mu$S/cm).  These data describe stressors associated with eutrophication (nitrogen, phosphorus) and serve as proxies for cultural enrichment where the rate of primary production may be excessive relative to background conditions.  Linkages between eutrophication and beneficial uses are strongly supported by the literature and nutrient observations could be considered "biostimulatory" substances in California streams, whereby a mechanistic link with biological integrity is represented in the stress-response model of the SQI.  Nitrogen, phosphorus, and conductivity are also widely available observations from regional and statewide monitoring programs and collectively act as surrogates for unmeasured or alternative water chemistry problems at a site (e.g., temperature, light penetration).  Additional water quality data that may also be important could include contaminants, such as pesticides, bacteria, or pharmaceuticals.  Although these contaminants can affect aquatic organisms, they are not routinely monitored and links with biological integrity and aquatic life uses are not as well understood as for nutrient-based stressors.  

Physical habitat conditions at a site were described using physical habitat metrics (PHAB, [@Rehn18]) and scores from the California Rapid Assessment Method (CRAM).  These data described the condition of physical habitat relative to flow characteristics, riparian condition, channel morphology, substrate type and diversity, and canopy shading.  As for biological communities, physical conditions vary naturally across geographic gradients such that observed data collected at one location may not be meaningfully compared to those from another location. A similar approach that was used for calibration of the biological indices was used to develop scoring methods for observed PHAB metrics that helped distinguish natural variability from anthropogenic stress.  Values range from 0 to ~ 1.4 with higher values indicating less deviation of physical habitat from reference.  As noted above, we consider physical habitat a critical component that influences biological condition, whereas both habitat and biology could be independently affected by external anthropogenic stressors.  For the purpose of the SQI, physical habitat was conceptually linked  to biology as a proximal stressor rather than a separate response measure of stress, although it could be used independently to do so or as a remedial step in identifying likely causes of poor condition.   

PHAB metrics included percent sands and fines (%SAFN), Shannon diversity of aquatic habitat types (H_AqHab), Shannon diversity of natural substrate types (H_SubNat), evenness of flow habitat types (Ev_FlowHab), and riparian vegetation cover (XCMG).  All of the metrics are positively associated with physical habitat integrity such that an increase in each was generally considered an improvement in site condition.  The exception is percent sands and fines where an increase is more commonly associated with degraded physical conditions (e.g., bank instability, watershed erosion).  All physical data used to collect PHAB metrics were collected using standard field protocols desribed in @Ode07.  Finally, the riverine module of CRAM was used to produce an additional, overall assessment score of physical habitat condition at each site [@Collins07;@Solek11].  CRAM component metrics individually assess buffer and landscape context, hydrology, physical structure, and biotic structure.  The combined score ranges from 25 to 100, with higher values indicating less degraded conditions at a site. As described below, PHAB and CRAM scores were jointly considered in their relationship to biological response endpoints. 

## Stream Quality Index

The stressor-response model to jointly evaluate the biological, physical, and chemical data for the SQI is conceptually represented in figure \@ref(fig:sqiflo). The overall SQI is a categorical outcome of biological condition (healthy/impacted) and stress condition (likelihood of impact) that is empirically based on the probability of observing biological alteration for observed stressor levels.  The empirical models that describe the probability of observing altered or unaltered biology were developed separately for chemistry and physical habitat stressors.  For both, a generalized additive model [@Wood06] was fit to calibration data to quantify smoothed functions for each separate water quality or physical habitat measure and how they are additively linked to binomial categories for altered or unaltered biology. Two models were developed:

\begin{equation}
pChem: p\left(bio\right) \sim  s\left(TN\right) + s\left(TP\right) + s\left(cond\right)
(\#eq:pchem)
\end{equation}

\begin{equation}
pHab: p\left(bio\right) \sim  s\left(PHAB\right) + s\left(CRAM\right)
(\#eq:phab)
\end{equation}

where $p\left(bio\right)$ is the probability of biological alteration in equations \@ref(eq:pchem) and \@ref(eq:phab) given smoothed function $s$ for each chemistry or physical habitat variable.  The probability of alteration is modelled using a logit link function for binomial variables, as $log\left(p / \left(1 - p\right)\right)$, where $p$ defines altered or unaltered biology.

An overall likelihood of biological alteration from both chemistry and physical habitat stressors was also estimated as a multiplicative function for $pChem$ and $pHab$:

\begin{equation}
pOverall: p\left(bio\right) \sim pChem \times pHab
(\#eq:poverall)
\end{equation}

Equations \@ref(eq:pchem), \@ref(eq:phab), and \@ref(eq:poverall) provided the empirical estimates of biological alteration that were used to define the categorical outputs of the SQI, defined below.  

Biological alteration using both the CSCI and ASCI as a binomial description for the above models required a framework to combine information from both indices.  As a conceptual model to link continuous data from each index to qualitative descriptions of condition, the biological condition gradient [BCG, @Davies06] framework was applied to both indices for binning scores into categories.  The BCG framework was initially developed to interpret bioassessment results based on independent methods and maps biological condition to different tiers of alteration across a generalized stressor gradient.  Specifically, sites in tier 1 are typically those with high bioassessment scores that are characteristic of pristine condtions, whereas sites in increasingly lower tiers indicating a transition from moderately to severely impacted condition.  Mapping biological index scores into tiers follows a semi-quantiative approach that combines numerical and narrative descriptions of condition.  The final categories are generally comparable between index types, e.g., tier 1 ASCI scores have a similar interpreation as tier 1 CSCI scores.  BCG tiers for the ASCI and CSCI were defined using methods in @Davies06 with considerable stakeholder input.  

For the stress models above, the assigned BCG tiers for each index were combined using a ranking system to create a single integer that represented an overall BCG condition reflected by both indices.  The general approach assumed strict independent applicability between the two indices, such that combined categories were assigned through best judgment (as opposed to averaging, best prevails, etc.).  The combined BCG categories ranged as integers from 5 to -5, with higher values indicating overall unaltered biological condtion.  For example, a site with ASCI and CSCI scores with BCG bins both equal to 1 was assigned a value of 5 to represent the combined biological condition.  The overall determination of a site having altered or unaltered biology for the binomial models was based on a breakpoint of zero for the combined categories, i.e., sites with combined scores from 1 to 5 were unaltered and sites from 0 to -5 were altered for both indices.

The empirical framework for the binomial models and BCG combined categories established a basis for the categorical descriptions from the SQI output.  These descriptions linked the quantitative data to management actions such that the results were easily interpreted with an indication of biological condition and the relevant stressors which may or may not be related to condition.  For the components in figure \@ref(fig:sqiflo), categorical outputs are provided by the index for the overall SQI, the biological condition, and the stress condition (figure \@ref(fig:sqicat)).  The categorical outputs were created from a matrix combination of the respective inputs.  The overall SQI categories describe the four possible combinations of biology and stressors at a site from the binary categories of altered/unaltered biology and stressed/unstressed conditions.  For the biological condition categories, the four possible outputs for a site that were based on the four combinations from the binary categories of high/low CSCI and high/low ASCI.  Finally, the possible stressor condition categories for a site were based on the four outcomes of the binary combinations of high/low chemistry stress and high/low physical habitat stress.  Because stress condition was multiplicative, a fifth category for the stressor condition category was also possible where the probability of overall stress ($pOverall$) exceeded the defined threshold for high/low stress even though the individual components for $pChem$ and $pHab$ were below the threshold.  Thresholds for biological indices that defined high/low condition were based on the tenth percentile distribution of scores at reference sites for each index.  Thresholds for high/low stress were conservative, whereby exceedance of a 33\% likelihood of biological alteration for any of the stress measures was considered high likelihood.

## Application

All data for the SQI were from the Stormwater Monitoring Coalition (SMC) regional monitoring program in southern California [@Mazor15].  This coalition represents multiple state, federal, and local agencies that have a shared mission of stormwater management for over 7000 stream kilometers.  The SMC initiated a regional monitoring program in 2009 for the purpose of permit re-allocations among member agencies.  Central monitoring questions focus on assessing biological condition, identifying stressors associated with condition, and evaluating trends over time.  This dataset represents the most comprehensive and only probailistic source of perennial stream data in Southern California.  Because the SQI requires synoptic biological, chemistry, and physical habitat data, the final dataset used for model calibration represents a subset of the SMC dataset where all three components were simultaneously collected. This included 263 sites, 75\% of which were used for model calibration.  Collection dates ranged from 2008 to 2015 with relatively even distribution of samples between years.  Most sample events occurred in June following standard protocols for perennial stream surveys [@Ode07].

Finally, precision and sensitivity of the SQI was evaluated to describe 1) how well the underlying empirical model described the likelihood of biological alteration, and 2) sensitivity of the model output to changing thresholds that defined the categorical conditions.  The first analysis evaluated precision in the validation dataset for the SQI to determine agreement between the model and actual stress and biological conditions.  The second analysis evaluated the change in results for the regional database that resulted from changing the categorical thresholds.  For example, the percentage of sites ranked as healthy and unstressed was compared by evaluating a change in the biological threshold for altered/unaltered biology, e.g., at 1\%, 10\%, and 30\% of reference scores for each index.     

# Results

Among all sites, the overall SQI categorized a majority as having altered biology under high stress conditions (impacted and stressed, 75\% of sites, Table \@ref(tab:sqicnt)).  Just over 5\% of sites were in the opposite category of unaltered biology in low stress conditions (healty and unstressed).  For the remaining two categories of the overall SQI, nearly 20\% of sites had unaltered biology but were under high stress conditions (healthy and resilient), whereas less than 1\% of sites had altered biology not related to physical or chemical stressors (impacted by unkown stress).  For the biological condition category, sites with altered conditions were more often indicated as impacted for both CSCI and ASCI scores (47%).  More sites were impacted for the ASCI (23%) than the CSCI (7%) if only one index was altered.  Less than a quarter of all sites had unaltered biology (23%).  For stress conditions, over 75% of sites were stressed by both chemistry and physical habitat stressors.  More sites were stressed by habitat degradation (11\%) than water chemistry (4\%) if only one stressor was present.  Only 6\% of sites had low stress, wheres 3\% of sites were impacted by the multiplicative combination of both low chemistry and physical habitat stressors.    

Spatial patterns among SQI categories in Southern California generally followed elevation and land use gradients (Figure \@ref(fig:sqimap)).  More impacted biological communities and high stress conditions were observed toward coastal areas in the lower watersheds and where urbanization is highest (e.g., Los Angeles, Orange County, Ventura, San Diego).  Sites with altered biological condition showed similar spatial patterns, although sites altered only for the ASCI were more often observed at mid-elevation in northern and southern locations in the study area. Stress condition patterns were similar to biology although low stress conditions were confined to the extreme northeast region of the study area, whereas healthy biological conditions were observed at a wider range of locations but still generally confined to high elevation. High stress conditions were also observed across a wider elevation gradient than biological alteration, i.e., resilient biological comunities in the presence of high stress were not uncommon (Table \@ref(tab:sqicnt)).    

Figure \@ref(fig:strlik), Figure \@ref(fig:rspcrv)

*	SQI performance metrics
     * 	Precision
     * 	Any others?
*	Percent So Cal stream miles or site frequency in each category
     * 	As a set up for the value of the categorical scoring
*	Overall agreement among stressor indicators
     * 	As a set up for do we need multiple indicators?
*	Overall agreement among response indicators
     * 	As a set up for do we need multiple indicators?
*	SQI trends either overall or at example sites

# Figures

```{r sqiflo, fig.cap = "Flowchart representation of the Stream Quality Index (SQI).  The overall SQI is a function of the likelihood of observing degraded biological condition given the stressors at a site.  Biological condition is assessed using macroinvertebrate (California Stream Condition Index, CSCI) and algal (Algal Stream Condition Index, ASCI) indices and stressors are evaluated based on water quality measures (total nitrogen, total phosphorus, conductivity) and physical habitat (California Rapid Assessment Method or CRAM, physical habitat metrics or PHAB). Stress condition is empirically linked to bilogical condition by separate probability functions for chemistry (pCHem) and physical habitat (pHab)."}
knitr::include_graphics('figs/sqi_flo.png')
```

```{r sqicat, fig.cap = "Categorical site descriptions that are possible from the Stream Quality Index (SQI).  The overall SQI is described as the possible outcomes from biological and stress conditions.  The biological conditions are described by the possible outcomes from the CSCI and ASCI.  The stress conditions are described by the possible outcomes from the chemistry and habitat stressors.  A fifth stress category is possible because stress from both chemistry and habitat was multiplicative."}
knitr::include_graphics('figs/sqi_cat.png')
```

```{r, results = 'hide'}
toplo <- alldatavg %>% 
  dplyr::select(MasterID, StreamHealthIndex, BiologicalCondition, OverallStressCondition_detail) %>% 
  gather('var', 'val', -MasterID, -geometry) %>% 
  mutate(
    var = factor(var, 
                 levels = c('StreamHealthIndex', 'BiologicalCondition', 'OverallStressCondition_detail'),
                 labels = c('Overall SQI', 'Biological condition', 'Stress condition'))
  )

toplo1 <- toplo %>% 
  filter(var %in% 'Overall SQI') %>% 
  mutate(
    val = factor(val, 
                 levels = c("Healthy and unstressed", "Healthy and resilient", "Impacted by unknown stress", "Impacted and stressed")
                 )
  )
toplo2 <- toplo %>% 
  filter(var %in% 'Biological condition') %>% 
  mutate(
    val = factor(val, 
                 levels = c("Healthy", "Impacted for CSCI", "Impacted for ASCI", "Impacted for CSCI and ASCI")
                 )
  )
toplo3 <- toplo %>% 
  filter(var %in% 'Stress condition') %>% 
  mutate(
    val = factor(val, 
                 levels = c("Low stress", "Stressed by chemistry degradation", "Stressed by habitat degradation", "Stressed by chemistry and habitat degradation", "Stressed by low levels of chemistry or habitat degradation")
                 )
  )

sqicol <- getdsccol(palfac = 'StreamHealthIndex')
biocol <- getdsccol(palfac = 'BiologicalCondition')
strcol <- getdsccol(palfac = 'OverallStressCondition_detail')

legpos <- 'right'
sz <- 3
p1 <- ggplot() + 
  geom_sf(data = sheds, colour = 'lightgrey') + 
  geom_sf(data = toplo1, aes(fill = val), pch = 21, colour = 'black', size = sz) + 
  facet_wrap(~var) + 
  # scale_colour_manual(values = sqicol$col) + 
  scale_fill_manual(values = sqicol$col) +
  theme_void(base_family = 'serif', base_size = 14) + 
  theme(
    legend.position = legpos,
    legend.title = element_blank(),
    legend.justification = "left"
  ) +
  guides(fill = guide_legend(override.aes = list(size = 0.5)))
p1leg <- g_legend(p1)
p1 <- p1 +
  theme(
    legend.position = 'none',
    panel.grid = element_line(colour = NA),
    strip.background = element_blank(),
    legend.title = element_blank()
    )
p2 <- ggplot() + 
  geom_sf(data = sheds, colour = 'lightgrey') + 
  geom_sf(data = toplo2, aes(fill = val), pch = 21, colour = 'black', size = sz) + 
  facet_wrap(~var) + 
  scale_fill_manual(values = biocol$col) +
  theme_void(base_family = 'serif', base_size = 14) + 
  theme(
    legend.position = legpos,
    legend.title = element_blank(),
    legend.justification = "left"
  ) +
  guides(fill = guide_legend(override.aes = list(size = 0.5)))
p2leg <- g_legend(p2)
p2 <- p2 +
  theme(
    legend.position = 'none',
    panel.grid = element_line(colour = NA),
    strip.background = element_blank(),
    legend.title = element_blank()
    )

p3 <- ggplot() + 
  geom_sf(data = sheds, colour = 'lightgrey') + 
  geom_sf(data = toplo3, aes(fill = val), pch = 21, colour = 'black', size = sz) + 
  facet_wrap(~var) + 
  scale_fill_manual(values = strcol$col) +
  theme_void(base_family = 'serif', base_size = 14) + 
  theme(
    legend.position = legpos, 
    legend.title = element_blank(),
    legend.justification = "left"
  ) +
  guides(fill = guide_legend(override.aes = list(size = 0.5)))
p3leg <- g_legend(p3)
p3 <- p3 +
  theme(
    legend.position = 'none',
    panel.grid = element_line(colour = NA),
    strip.background = element_blank(),
    legend.title = element_blank()
    )

maxWidth = grid::unit.pmax(p1leg$widths[2:5], p2leg$widths[2:5], p3leg$widths[2:5])
 p1leg$widths[2:5] <- as.list(maxWidth)
 p2leg$widths[2:5] <- as.list(maxWidth)
 p3leg$widths[2:5] <- as.list(maxWidth)

png('figs/sqi_map.png', height = 8, width = 8, units = 'in', res = 500)
grid.arrange(
  arrangeGrob(p1, p2, p3, ncol=1),
  arrangeGrob(p1leg, p2leg, p3leg, ncol=1),
  ncol = 2)
dev.off()
```
```{r sqimap, fig.cap = "Categorical site descriptions for the Stream Quality Index (SQI) at monitoring sites in Southern California.  The overall SQI (top) is described as the possible outcomes from biological (middle) and stress conditions (bottom).  The biological conditions are described by the possible outcomes from the CSCI and ASCI.  The stress conditions are described by the possible outcomes from the chemistry and habitat stressors."}
knitr::include_graphics('figs/sqi_map.png')
```


```{r, results = 'hide'}
toplo <- alldatavg %>% 
  st_set_geometry(NULL) %>% 
  select(pChem, pHab, pChemHab) 

xgrid <- seq(min(toplo$pHab, na.rm = T), max(toplo$pHab, na.rm = T), length = 100)
ygrid <- seq(min(toplo$pChem, na.rm = T), max(toplo$pChem, na.rm = T), length = 100)

data.fit <- expand.grid(pHab = xgrid, pChem = ygrid)

data.loess <- loess(pChemHab ~ pHab * pChem, data = toplo)
mtrxd <- predict(data.loess, newdata = data.fit) %>% 
  reshape2::melt() %>% 
  mutate(
    pHab = as.numeric(gsub('^pHab=', '', pHab)), 
    pChem = as.numeric(gsub('^pChem=', '', pChem))
  ) %>% 
  rename(pChemHab = value)

cols <- getdsccol(palfac = 'OverallStressCondition')$col

p <- ggplot(mtrxd, aes(x = pChem, y = pHab, z = pChemHab)) + 
  stat_contour(aes(colour = ..level..)) + 
  geom_point(data = toplo, aes(x = pChem, y = pHab, fill = pChemHab), pch = 21, colour = 'lightgrey', size = 4) +
  theme_bw(base_family= 'serif') + 
  theme(
    legend.position = 'top',
    legend.title = element_text(face = 'italic'), 
    axis.title = element_text(face = 'italic')
  ) + 
  scale_colour_gradientn('pOverall', colours = cols, guide = F)+
  scale_fill_gradientn('pOverall', colours = cols)


p <- direct.label(p, list('bottom.pieces', cex = 0.7))

png('figs/str_lik.png', height = 5, width = 4.5, family = 'serif', res = 400, units = 'in')
p
dev.off()
```
```{r strlik, fig.cap = "Relationship between stress models for water chemistry (*pChem*, eqn. \\\\@ref(eq:pchem)) and physical habitat (*pHab*, eqn. \\\\@ref(eq:phab).  Stress models for water chemistry and physical habitat were created based on the likelihood of biological alteration for the observed stress measures.  The overall stress meaures (*pOverall*, eqn. \\\\@ref(eq:poverall)) is the product of both stress models.  Points represent estimated stress at a single site."}
knitr::include_graphics('figs/str_lik.png')
```


```{r, results = 'hide'}
opt_vrs <- list(
 TN2 = 0,
 TP = 0.1,
 Cond = 100
 )  

# wq
toplotn <- strs_surf('TN2', mod  = 'wq_mod', mod_in = 'wqglm', opt_vrs = opt_vrs)
toplotp <- strs_surf('TP', mod  = 'wq_mod', mod_in = 'wqglm', opt_vrs = opt_vrs)
toplocn <- strs_surf('Cond', mod  = 'wq_mod', mod_in = 'wqglm', opt_vrs = opt_vrs)

# plots
p1 <- ggplot(toplotn, aes(x = TN2, y = fit)) +
  geom_ribbon(aes(ymin = fit - fitse, ymax = fit + fitse), fill = 'lightblue', colour = NA, alpha = 0.6) +
  geom_line() +
  geom_line(aes(y = fit + fitse), linetype = 'dashed') + 
  geom_line(aes(y = fit - fitse), linetype = 'dashed') + 
  theme_bw(base_size = 12,base_family = 'serif') +
  xlab('Total Nitrogen (mg/L)') + 
  theme(axis.title.y = element_blank())
    
p2 <- ggplot(toplotp, aes(x = TP, y = fit)) +
  geom_ribbon(aes(ymin = fit - fitse, ymax = fit + fitse), fill = 'lightblue', colour = NA, alpha = 0.6) +
  geom_line() +
  geom_line(aes(y = fit + fitse), linetype = 'dashed') + 
  geom_line(aes(y = fit - fitse), linetype = 'dashed') + 
  theme_bw(base_size = 12,base_family = 'serif') +
  xlab('Total phosphorus (mg/L)') + 
  theme(axis.title.y = element_blank())
    
p3 <- ggplot(toplocn, aes(x = Cond, y = fit)) +
  geom_ribbon(aes(ymin = fit - fitse, ymax = fit + fitse), fill = 'lightblue', colour = NA, alpha = 0.6) +
  geom_line() +
  geom_line(aes(y = fit + fitse), linetype = 'dashed') + 
  geom_line(aes(y = fit - fitse), linetype = 'dashed') + 
  theme_bw(base_size = 12,base_family = 'serif') +
  xlab('Conductivity (uS/cm)') + 
  theme(axis.title.y = element_blank())
  
opt_vrs <- list(
    indexscore_cram = 100,
    PCT_SAFN = 0,
    H_AqHab = 1.5,
    H_SubNat = 1.5,
    Ev_FlowHab = 1.5,
    XCMG = 50
  )

# hab
toplocrm <- strs_surf('indexscore_cram', mod  = 'hab_mod', mod_in = 'habglm', opt_vrs = opt_vrs)
toplosaf <- strs_surf('PCT_SAFN', mod  = 'hab_mod', mod_in = 'habglm', opt_vrs = opt_vrs)
toploaqh <- strs_surf('H_AqHab', mod  = 'hab_mod', mod_in = 'habglm', opt_vrs = opt_vrs)
toplosbn <- strs_surf('H_SubNat', mod  = 'hab_mod', mod_in = 'habglm', opt_vrs = opt_vrs)
toploflo <- strs_surf('Ev_FlowHab', mod  = 'hab_mod', mod_in = 'habglm', opt_vrs = opt_vrs)
toplocmg <- strs_surf('XCMG', mod  = 'hab_mod', mod_in = 'habglm', opt_vrs = opt_vrs)

# plots
p4 <- ggplot(toplocrm, aes(x = indexscore_cram, y = fit)) +
  geom_ribbon(aes(ymin = fit - fitse, ymax = fit + fitse), fill = 'lightblue', colour = NA, alpha = 0.6) +
  geom_line() +
  geom_line(aes(y = fit + fitse), linetype = 'dashed') + 
  geom_line(aes(y = fit - fitse), linetype = 'dashed') + 
  theme_bw(base_size = 12,base_family = 'serif') +
  xlab('CRAM') + 
  theme(axis.title.y = element_blank())
    
p5 <- ggplot(toplosaf, aes(x = PCT_SAFN, y = fit)) +
  geom_ribbon(aes(ymin = fit - fitse, ymax = fit + fitse), fill = 'lightblue', colour = NA, alpha = 0.6) +
  geom_line() +
  geom_line(aes(y = fit + fitse), linetype = 'dashed') + 
  geom_line(aes(y = fit - fitse), linetype = 'dashed') + 
  theme_bw(base_size = 12,base_family = 'serif') +
  xlab('% sands and fines') + 
  theme(axis.title.y = element_blank())
    
p6 <- ggplot(toploaqh, aes(x = H_AqHab, y = fit)) +
  geom_ribbon(aes(ymin = fit - fitse, ymax = fit + fitse), fill = 'lightblue', colour = NA, alpha = 0.6) +
  geom_line() +
  geom_line(aes(y = fit + fitse), linetype = 'dashed') + 
  geom_line(aes(y = fit - fitse), linetype = 'dashed') + 
  theme_bw(base_size = 12,base_family = 'serif') +
  xlab('Diversity of habitat') + 
  theme(axis.title.y = element_blank())

p7 <- ggplot(toplosbn, aes(x = H_SubNat, y = fit)) +
  geom_ribbon(aes(ymin = fit - fitse, ymax = fit + fitse), fill = 'lightblue', colour = NA, alpha = 0.6) +
  geom_line() +
  geom_line(aes(y = fit + fitse), linetype = 'dashed') + 
  geom_line(aes(y = fit - fitse), linetype = 'dashed') + 
  theme_bw(base_size = 12,base_family = 'serif') +
  xlab('Diversity of substrate') + 
  theme(axis.title.y = element_blank())

p8 <- ggplot(toploflo, aes(x = Ev_FlowHab, y = fit)) +
  geom_ribbon(aes(ymin = fit - fitse, ymax = fit + fitse), fill = 'lightblue', colour = NA, alpha = 0.6) +
  geom_line() +
  geom_line(aes(y = fit + fitse), linetype = 'dashed') + 
  geom_line(aes(y = fit - fitse), linetype = 'dashed') + 
  theme_bw(base_size = 12,base_family = 'serif') +
  xlab('Evenness of flow') + 
  theme(axis.title.y = element_blank())

p9 <- ggplot(toplocmg, aes(x = XCMG, y = fit)) +
  geom_ribbon(aes(ymin = fit - fitse, ymax = fit + fitse), fill = 'lightblue', colour = NA, alpha = 0.6) +
  geom_line() +
  geom_line(aes(y = fit + fitse), linetype = 'dashed') + 
  geom_line(aes(y = fit - fitse), linetype = 'dashed') + 
  theme_bw(base_size = 12,base_family = 'serif') +
  xlab('% cover') + 
  theme(axis.title.y = element_blank())

png('figs/rsp_crv.png', height = 6, width = 11, res = 500, units = 'in', family = 'serif')
grid.arrange(
  left = textGrob('Likelihood of alteration', rot = 90), 
  arrangeGrob(
    textGrob('Water chemistry', just = 'left'), 
    arrangeGrob(p1, p2, p3, ncol = 3),
    textGrob('Physical habitat', just = 'left'), 
    arrangeGrob(p4, p5, p6, p7, p8, p9, ncol = 6), 
    ncol = 1, heights = c(0.1, 1, 0.1, 1)
  )
)
dev.off()
```
```{r rspcrv, fig.cap = "Modelled likelihood of biological alteration from water quality (top) and physical habitat stressors (bottom). Curves are the binomial likelihood (+/- standard error) of biological condition being altered (as measured by macroinvertebrate and algal indices) across the range of observed values for water quality and physical habitat stressors on the x-axes.  The water chemistry and physical habitat stress plots are derived from equations \\\\@ref(eq:pchem) and \\\\@ref(eq:phab).  Other variables in each model not on the x-axis for each plot are held constant at values for low stress conditions."}
knitr::include_graphics('figs/rsp_crv.png')
```

# Tables

```{r sqicnt}
totab <- alldatavg %>% 
  st_set_geometry(NULL) %>% 
  select(MasterID, BiologicalCondition, OverallStressCondition_detail, StreamHealthIndex) %>% 
  rename(
    `Biological condition` = BiologicalCondition, 
    `Stress condition` = OverallStressCondition_detail,
    `Overall SQI` = StreamHealthIndex
  ) %>% 
  gather('var', 'val', -MasterID) %>% 
  group_by(var, val) %>%
  summarise(
    cnt = n()
  ) %>% 
  mutate(
    per = round(100 * cnt / sum(cnt), 1), 
    per = paste0('(', per, ')')
  ) %>% 
  ungroup %>% 
  mutate(
    val = factor(val, levels = c("Healthy and unstressed", "Healthy and resilient", "Impacted and stressed", "Impacted by unknown stress", "Healthy", "Impacted for ASCI", "Impacted for CSCI", "Impacted for CSCI and ASCI",  "Low stress", "Stressed by chemistry and habitat degradation", "Stressed by chemistry degradation", "Stressed by habitat degradation", "Stressed by low levels of chemistry or habitat degradation"))
  ) %>% 
  arrange(val) %>%
  mutate(var = ifelse(duplicated(var), '', var)) %>% 
  rename(
    `SQI output` = var, 
    `Category` = val
  ) %>% 
  unite('Count (percent)', cnt, per, sep = ' ' )
  
# table stuff
cap.val <- 'Counts of sites in each of the categorical outputs from the SQI.  For every SQI output (biological condition, overall SQI, stress condition), a site is categorized as one of four possible outcomes.'

# table
knitr::kable(totab, booktabs = T, caption = cap.val)
```

# References

